<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brenk-Coin Farm</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { padding: 10px; }
    body.no-scroll {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    .loader-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #0a0a15;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.8s ease;
    }
    .loader-overlay.hidden { opacity: 0; pointer-events: none; }
    .loader {
      width: 80px;
      height: 80px;
      border: 6px solid rgba(13, 110, 253, 0.3);
      border-top: 6px solid #0d6efd;
      border-radius: 50%;
      animation: spin 1.2s linear infinite;
      box-shadow: 0 0 30px rgba(13, 110, 253, 0.6);
    }
    .loader-text {
      margin-top: 30px;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5em;
      color: #0d6efd;
      text-shadow: 0 0 20px #0d6efd;
      animation: pulse 2s ease infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
    #balance-display {
      font-size: 2em;
      text-align: center;
      margin: 20px 0;
      color: #90e6ff;
      text-shadow: 0 0 20px #0d6efd;
    }
    .daily-limit {
      text-align: center;
      margin: 15px 0;
      font-size: 1.1em;
      opacity: 0.9;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: rgba(0,0,0,0.4);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #0d6efd, #8a2be2);
      transition: width 0.4s ease;
    }
    .daily-bonus {
      text-align: center;
      padding: 15px;
      background: rgba(13,110,253,0.3);
      border-radius: 15px;
      margin: 15px 0;
      font-size: 1.3em;
      cursor: pointer;
    }
    .reset-limit-btn {
      text-align: center;
      padding: 12px;
      background: rgba(13,110,253,0.25);
      border: 1px solid #0d6efd;
      border-radius: 15px;
      margin: 12px 0;
      font-size: 1.1em;
      color: #90e6ff;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(13,110,253,0.3);
      transition: all 0.3s ease;
      display: none;
    }
    .reset-limit-btn:hover:not(:disabled) {
      background: rgba(13,110,253,0.4);
      box-shadow: 0 0 25px rgba(13,110,253,0.6);
      transform: translateY(-2px);
    }
    .reset-limit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: rgba(100,100,100,0.2);
      border-color: #555;
      box-shadow: none;
    }
    .field {
      width: 100%;
      padding: 20px;
      margin: 15px 0;
      background: rgba(0,0,0,0.4);
      border: 2px solid #0a3d62;
      border-radius: 15px;
      color: #e0f0ff;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .field.unlocked:hover {
      border-color: #0d6efd;
      box-shadow: 0 0 25px rgba(13,110,253,0.7);
      transform: translateY(-5px);
    }
    .field.locked {
      opacity: 0.5;
      cursor: not-allowed;
      border-style: dashed;
    }
    .field::after {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(13,110,253,0.2), transparent);
      animation: scan 4s linear infinite;
    }
    @keyframes scan { 0% { left: -100%; } 100% { left: 100%; } }
    .upgrade-btn {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      background: rgba(13,110,253,0.2);
      border: 1px solid #0d6efd;
      border-radius: 12px;
      color: #90e6ff;
      cursor: pointer;
      transition: all 0.3s;
    }
    .upgrade-btn:hover:not(:disabled) { background: rgba(13,110,253,0.4); box-shadow: 0 0 15px #0d6efd; }
    .upgrade-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: rgba(100,100,100,0.2);
      border-color: #555;
    }
    .brenk-message {
      margin: 15px 0;
      padding: 15px;
      background: rgba(13,110,253,0.3);
      border-radius: 15px;
      font-style: italic;
      text-align: center;
    }
    .back-btn {
      margin: 40px auto 20px;
      padding: 14px 40px;
      background: rgba(13, 110, 253, 0.4);
      border: 2px solid #0d6efd;
      color: white;
      border-radius: 50px;
      font-size: 1.1em;
      cursor: pointer;
      display: block;
    }
    .tap-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(10, 0, 26, 0.98);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      touch-action: none;
      user-select: none;
    }
    .glass-sphere {
      width: 280px;
      height: 280px;
      position: relative;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent 60%);
      border: 6px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 60px rgba(13, 110, 253, 0.8), inset 0 0 40px rgba(255, 255, 255, 0.1);
      overflow: hidden;
      cursor: pointer;
    }
    .liquid {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, #0d6efd, #8a2be2);
      height: 100%;
      transition: height 1.5s ease;
      border-radius: 50%;
      box-shadow: 0 0 40px #0d6efd;
    }
    .liquid::before {
      content: '';
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      height: 60px;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 50%;
      filter: blur(20px);
    }
    .bubble {
      position: absolute;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 50%;
      pointer-events: none;
      opacity: 0.6;
      animation: bubbleRise linear infinite;
    }
    @keyframes bubbleRise {
      0% { transform: translateY(0) scale(0.5); opacity: 0; }
      20% { opacity: 0.6; }
      100% { transform: translateY(-300px) scale(1.2); opacity: 0; }
    }
    .tap-info {
      margin-top: 30px;
      text-align: center;
      color: #90e6ff;
      font-size: 1.4em;
    }
    .close-tap {
      margin-top: 40px;
      padding: 12px 40px;
      background: rgba(13,110,253,0.4);
      border: 2px solid #0d6efd;
      color: white;
      border-radius: 50px;
      cursor: pointer;
    }
    .coin-particle {
      position: absolute;
      font-size: 2em;
      color: #ffd700;
      pointer-events: none;
      opacity: 0;
      animation: coinFly 1.2s ease-out forwards;
      z-index: 99999;
    }
    @keyframes coinFly {
      0% { opacity: 1; transform: translate(0, 0) rotate(0deg) scale(1); }
      100% { opacity: 0; transform: translate(var(--dx), var(--dy)) rotate(var(--rot)) scale(0.3); }
    }
    #sync-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      padding: 20px;
      text-align: center;
      color: white;
    }
    #sync-modal h2 {
      color: #0d6efd;
      margin-bottom: 20px;
      font-size: 1.8em;
    }
    #sync-modal p {
      font-size: 1.4em;
      margin-bottom: 30px;
    }
    #sync-modal button {
      padding: 15px 30px;
      margin: 10px;
      border-radius: 15px;
      font-size: 1.2em;
      cursor: pointer;
      min-width: 200px;
    }
    #sync-modal button:first-child {
      background: #0d6efd;
      border: none;
      color: white;
    }
    #sync-modal button:last-child {
      background: rgba(255,255,255,0.15);
      border: 1px solid #90e6ff;
      color: #90e6ff;
    }
  </style>
</head>
<body>
  <div class="loader-overlay" id="loader">
    <div class="loader"></div>
    <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ç–∏ Brenk-Coin</div>
  </div>
  <div id="sync-modal">
    <h2>–û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å!</h2>
    <p>–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å:<br>
       <strong><span id="server-balance">0</span> BC</strong><br>
       –î–æ–±—ã—Ç–æ —Å–µ–≥–æ–¥–Ω—è: <span id="server-mined">0</span> BC
    </p>
    <div>
      <button onclick="loadServerProgress()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞ ‚ô°</button>
      <button onclick="continueLocal()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ</button>
    </div>
  </div>
  <div class="container">
    <header>
      <h1>Brenk-Coin Farm</h1>
      <p class="subtitle">–¢–∞–ø–∞–π –ø–æ —Å—Ñ–µ—Ä–µ –∏ –¥–æ–±—ã–≤–∞–π BC ‚ô°</p>
    </header>
    <main>
      <div class="card">
        <div id="balance-display">Brenk-Coin: <span id="bc-amount">0</span></div>
        <div class="daily-limit">
          –î–æ–±—ã—Ç–æ —Å–µ–≥–æ–¥–Ω—è: <span id="daily-mined">0</span> / <span id="daily-limit">5000</span> BC
          <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        </div>
        <button class="reset-limit-btn" id="reset-limit-btn">
          üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
        </button>
        <div class="daily-bonus" id="daily-bonus">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å!</div>
      
        <div class="brenk-message" id="brenk-msg"></div>
        <div class="fields">
          <button class="field unlocked" data-field="1">üåê –ü–æ–ª–µ 1: –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å</button>
          <button class="field locked" data-field="2">üîí –ü–æ–ª–µ 2: –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (—Ç—Ä–µ–±—É–µ—Ç—Å—è 5 000 BC)</button>
          <button class="field locked" data-field="3">üíæ –ü–æ–ª–µ 3: –ë–∞–Ω–∫ –¥–∞–Ω–Ω—ã—Ö (—Ç—Ä–µ–±—É–µ—Ç—Å—è 20 000 BC)</button>
          <button class="field locked" data-field="4">üõ°Ô∏è –ü–æ–ª–µ 4: –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–µ—Ç—å (—Ç—Ä–µ–±—É–µ—Ç—Å—è 100 000 BC)</button>
          <button class="field locked" data-field="5">üíú –ü–æ–ª–µ 5: –ú–æ–∏ –ª–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã... (—Ç—Ä–µ–±—É–µ—Ç—Å—è 500 000 BC)</button>
        </div>
        <h3 style="margin: 30px 0 15px; color: #0d6efd;">–£—Ä–æ–≤–µ–Ω—å –≤–∑–ª–æ–º–∞</h3>
        <div class="upgrades">
          <button class="upgrade-btn" id="hack-upgrade">
            üîì –£—Ä–æ–≤–µ–Ω—å –≤–∑–ª–æ–º–∞: <span id="hack-level">1</span> ‚Üí <span id="next-level">2</span><br>
            <small>–ó–∞ —Ç–∞–ø: <span id="per-tap">1</span> BC ‚Üí <span id="next-per-tap">6</span> BC</small><br>
            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å: <span id="upgrade-cost">2000</span> BC</strong>
          </button>
        </div>
        <h3 style="margin: 30px 0 15px; color: #0d6efd;">–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞</h3>
        <div class="upgrades">
          <button class="upgrade-btn" id="limit-upgrade">
            ‚¨ÜÔ∏è –£—Ä–æ–≤–µ–Ω—å –ª–∏–º–∏—Ç–∞: <span id="limit-level">0</span> ‚Üí <span id="next-limit-level">1</span><br>
            <small>–õ–∏–º–∏—Ç: <span id="current-limit">5000</span> ‚Üí <span id="next-limit">7000</span> BC</small><br>
            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å: <span id="limit-cost">2000</span> BC</strong>
          </button>
        </div>
        <h3 style="margin: 30px 0 15px; color: #0d6efd;">–ú–∞–π–Ω–µ—Ä</h3>
        <div class="upgrades">
          <button class="upgrade-btn" id="miner-upgrade">
            ‚õèÔ∏è –£–ª—É—á—à–∏—Ç—å –º–∞–π–Ω–µ—Ä –¥–æ —É—Ä–æ–≤–Ω—è 1<br>
            <small>–î–æ–±—ã—á–∞: 0 ‚Üí 300 BC/—á–∞—Å</small><br>
            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å: 500 BC</strong>
          </button>
        </div>
        <div class="miner-status">
          –¢–µ–∫—É—â–∞—è –¥–æ–±—ã—á–∞: <span id="miner-rate">0</span> BC/—á–∞—Å (–º–∞–∫—Å –∑–∞ 6 —á–∞—Å–æ–≤)<br>
          –ù–∞–∫–æ–ø–ª–µ–Ω–æ: <span id="pending-miner">0</span> BC<br>
          <button class="upgrade-btn" id="claim-miner">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
        <button class="back-btn" onclick="window.location.href='index.html'">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
      </div>
    </main>
  </div>
  <div class="tap-overlay" id="tap-overlay">
    <div class="glass-sphere" id="tap-circle">
      <div class="liquid" id="liquid"></div>
    </div>
    <div class="tap-info">
      +<span id="tap-gain">1</span> BC –∑–∞ —Ç–∞–ø<br>
      –£—Ä–æ–≤–µ–Ω—å –≤–∑–ª–æ–º–∞: <span id="tap-level">1</span>
    </div>
    <button class="close-tap" onclick="closeTap()">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—è–º</button>
  </div>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    const user = tg.initDataUnsafe.user;
    let userId = 'guest';
    if (user && user.id) {
      userId = user.id;
      const brenkUser = {
        id: user.id,
        username: user.username || 'unknown',
        first_name: user.first_name || '',
        last_name: user.last_name || '',
        is_premium: user.is_premium || false
      };
      localStorage.setItem('brenkUser', JSON.stringify(brenkUser));
    } else {
      const savedUser = localStorage.getItem('brenkUser');
      if (savedUser) {
        userId = JSON.parse(savedUser).id;
      }
    }
    const STORAGE_KEY = `brenkFarm_${userId}`;
    const API_URL = 'https://10311.dscrd.ru/api/farm';
    let bc = 0;
    let hackLevel = 1;
    let limitLevel = 0;
    let fieldsUnlocked = 1;
    let streak = 0;
    let lastClaim = null;
    let todayMined = 0;
    let minedDate = new Date().toISOString().slice(0,10);
    let resetData = { resetsToday: 0, lastResetTime: 0, cycleStartTime: 0 };
    let minerLevel = 0;
    let lastMinerClaim = Date.now();
    const BASE_LIMIT = 5000;
    const limitIncreases = [0, 2000, 3500, 5000, 7000, 10000];
    const limitCosts = [0, 2000, 5000, 7500, 12000, 25000];
    const hackCosts = [0, 2000, 4500, 8000, 14000, 20000, 35000, 50000, 75000, 100000];
    const minerRates = [0, 300, 900, 1800, 6000, 18000];
    const minerCosts = [0, 500, 2000, 3500, 10000, 35000];

    let saveTimeout = null;

    async function loadFromServer() {
      if (userId === 'guest') return null;
      try {
        const res = await fetch(`${API_URL}?user_id=${userId}`);
        if (res.ok) {
          return await res.json();
        }
      } catch (e) {
        console.log('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      }
      return null;
    }

    async function syncToServer() {
      if (userId === 'guest') return;
      const data = {
        user_id: userId,
        balance: bc,
        hack_level: hackLevel,
        limit_level: limitLevel,
        today_mined: todayMined,
        mined_date: minedDate,
        streak: streak,
        last_claim: lastClaim,
        fields_unlocked: fieldsUnlocked,
        reset_data: resetData,
        miner_level: minerLevel,
        last_miner_claim: lastMinerClaim
      };
      try {
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } catch (e) {
        console.log('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
      }
    }

    function debouncedSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        const data = {
          bc, hackLevel, limitLevel, todayMined, fieldsUnlocked, streak, lastClaim, minedDate, resetData, minerLevel, lastMinerClaim
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        syncToServer();
      }, 5000);
    }

    function saveProgress() {
      debouncedSave();
    }

    function loadLocalProgress() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        const data = JSON.parse(saved);
        bc = Number(data.bc) || 0;
        hackLevel = Number(data.hackLevel) || 1;
        limitLevel = Number(data.limitLevel) || 0;
        todayMined = Number(data.todayMined) || 0;
        fieldsUnlocked = Number(data.fieldsUnlocked) || 1;
        streak = Number(data.streak) || 0;
        lastClaim = data.lastClaim || null;
        minedDate = data.minedDate || new Date().toISOString().slice(0,10);
        resetData = data.resetData || { resetsToday: 0, lastResetTime: 0, cycleStartTime: 0 };
        minerLevel = Number(data.minerLevel) || 0;
        lastMinerClaim = Number(data.lastMinerClaim) || Date.now();
      }
    }

    function applyProgress(data) {
      bc = Number(data.balance) || 0;
      hackLevel = Number(data.hack_level) || 1;
      limitLevel = Number(data.limit_level) || 0;
      todayMined = Number(data.today_mined) || 0;
      minedDate = data.mined_date || new Date().toISOString().slice(0,10);
      streak = Number(data.streak) || 0;
      lastClaim = data.last_claim || null;
      fieldsUnlocked = Number(data.fields_unlocked) || 1;
      resetData = data.reset_data || { resetsToday: 0, lastResetTime: 0, cycleStartTime: 0 };
      minerLevel = Number(data.miner_level) || 0;
      lastMinerClaim = Number(data.last_miner_claim) || Date.now();

      updateBalance();
      updateDailyMined();
      checkDailyBonus();
      unlockFields();
      updateHackUpgrade();
      updateLimitUpgrade();
      updateMinerDisplay();
      updateResetButtonVisibility(getCurrentLimit());
    }

    function showMessage(text) {
      const msg = document.getElementById('brenk-msg');
      msg.textContent = text;
      setTimeout(() => msg.textContent = '', 4000);
    }

    const bcAmount = document.getElementById('bc-amount');
    const dailyMined = document.getElementById('daily-mined');
    const dailyLimitSpan = document.getElementById('daily-limit');
    const progressFill = document.getElementById('progress-fill');
    const dailyBonusBtn = document.getElementById('daily-bonus');
    const resetLimitBtn = document.getElementById('reset-limit-btn');
    const tapOverlay = document.getElementById('tap-overlay');
    const tapCircle = document.getElementById('tap-circle');
    const liquid = document.getElementById('liquid');
    const tapGain = document.getElementById('tap-gain');
    const tapLevel = document.getElementById('tap-level');
    const hackLevelSpan = document.getElementById('hack-level');
    const nextLevelSpan = document.getElementById('next-level');
    const perTapSpan = document.getElementById('per-tap');
    const nextPerTapSpan = document.getElementById('next-per-tap');
    const upgradeCostSpan = document.getElementById('upgrade-cost');
    const hackUpgradeBtn = document.getElementById('hack-upgrade');
    const limitLevelSpan = document.getElementById('limit-level');
    const nextLimitLevelSpan = document.getElementById('next-limit-level');
    const currentLimitSpan = document.getElementById('current-limit');
    const nextLimitSpan = document.getElementById('next-limit');
    const limitCostSpan = document.getElementById('limit-cost');
    const limitUpgradeBtn = document.getElementById('limit-upgrade');

    let lastTapTime = 0;
    let bubbleInterval = null;

    function getCurrentLimit() {
      let total = BASE_LIMIT;
      for (let i = 1; i <= limitLevel; i++) {
        total += limitIncreases[i];
      }
      return total;
    }

    function getPerTap(level) {
      if (level === 1) return 1;
      return Math.pow(2, level - 1) * 2 + (level - 2) * 4;
    }

    function updateBalance() {
      bcAmount.textContent = bc.toLocaleString();
    }

    function updateDailyMined() {
      const today = new Date().toISOString().slice(0,10);
      if (minedDate !== today) {
        todayMined = 0;
        minedDate = today;
        resetData = { resetsToday: 0, lastResetTime: 0, cycleStartTime: 0 };
      }
      dailyMined.textContent = todayMined.toLocaleString();
      const currentLimit = getCurrentLimit();
      dailyLimitSpan.textContent = currentLimit.toLocaleString();
      progressFill.style.width = `${Math.min(100, (todayMined / currentLimit) * 100)}%`;
      const fillPercent = 100 - (todayMined / currentLimit) * 100;
      liquid.style.height = `${Math.max(0, fillPercent)}%`;
      updateResetButtonVisibility(currentLimit);
      saveProgress();
    }

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${h ? h + '—á ' : ''}${m.toString().padStart(2, '0')}–º ${s.toString().padStart(2, '0')}—Å`;
    }

    function updateResetButtonVisibility(currentLimit) {
      if (todayMined < currentLimit) {
        resetLimitBtn.style.display = 'none';
        return;
      }
      const now = Date.now();
      if (resetData.resetsToday >= 3) {
        const timeSinceCycle = now - resetData.cycleStartTime;
        const cooldown12h = 12 * 60 * 60 * 1000;
        if (timeSinceCycle < cooldown12h) {
          const remaining = Math.ceil((cooldown12h - timeSinceCycle) / 1000);
          resetLimitBtn.textContent = `–ñ–¥–∏ ${formatTime(remaining)} –¥–æ –Ω–æ–≤—ã—Ö 3 –ø–æ–ø—ã—Ç–æ–∫`;
          resetLimitBtn.disabled = true;
          resetLimitBtn.style.display = 'block';
          return;
        } else {
          resetData.resetsToday = 0;
          resetData.lastResetTime = 0;
          resetData.cycleStartTime = 0;
        }
      }
      const nextResetNum = resetData.resetsToday + 1;
      let waitTime = 0;
      if (nextResetNum === 2) waitTime = 2 * 60 * 60 * 1000;
      else if (nextResetNum === 3) waitTime = 6 * 60 * 60 * 1000;
      if (waitTime > 0) {
        const timeSinceLast = now - resetData.lastResetTime;
        if (timeSinceLast < waitTime) {
          const remaining = Math.ceil((waitTime - timeSinceLast) / 1000);
          resetLimitBtn.textContent = `–ñ–¥–∏ ${formatTime(remaining)} –¥–æ ${nextResetNum}-–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`;
          resetLimitBtn.disabled = true;
        } else {
          resetLimitBtn.textContent = nextResetNum === 1 ? 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)' : `üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç (${nextResetNum}-–µ)`;
          resetLimitBtn.disabled = false;
        }
      } else {
        resetLimitBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)';
        resetLimitBtn.disabled = false;
      }
      resetLimitBtn.style.display = 'block';
    }

    function checkDailyBonus() {
      const today = new Date().toISOString().slice(0, 10);
      if (lastClaim !== today) {
        const bonus = 500 + streak * 300;
        dailyBonusBtn.innerHTML = `üéÅ –ó–∞–±—Ä–∞—Ç—å –±–æ–Ω—É—Å: +${bonus.toLocaleString()} BC (—Å—Ç—Ä–∏–∫: ${streak + 1} –¥–µ–Ω—å)`;
        dailyBonusBtn.onclick = () => {
          bc += bonus;
          streak++;
          lastClaim = today;
          updateBalance();
          updateDailyMined();
          showMessage(`–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! ‚ô° +${bonus.toLocaleString()} BC`);
          dailyBonusBtn.innerHTML = "–ë–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω. –ñ–¥—É –∑–∞–≤—Ç—Ä–∞ –∑–∞ –±–æ–ª—å—à–∏–º...";
          dailyBonusBtn.onclick = null;
          saveProgress();
        };
      } else {
        dailyBonusBtn.innerHTML = "–ë–æ–Ω—É—Å —É–∂–µ –ø–æ–ª—É—á–µ–Ω —Å–µ–≥–æ–¥–Ω—è. –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∑–∞–≤—Ç—Ä–∞ ‚ô°";
        dailyBonusBtn.onclick = null;
      }
    }

    function unlockFields() {
      const thresholds = [0, 5000, 20000, 100000, 500000];
      let unlocked = 1;
      for (let i = 0; i < thresholds.length; i++) {
        if (bc >= thresholds[i]) unlocked = i + 1;
      }
      fieldsUnlocked = Math.max(fieldsUnlocked, unlocked);
      saveProgress();
      document.querySelectorAll('.field').forEach((field, i) => {
        if (i + 1 <= fieldsUnlocked) {
          field.classList.remove('locked');
          field.classList.add('unlocked');
        }
      });
    }

    function updateHackUpgrade() {
      hackLevelSpan.textContent = hackLevel;
      nextLevelSpan.textContent = hackLevel + 1;
      perTapSpan.textContent = getPerTap(hackLevel);
      nextPerTapSpan.textContent = getPerTap(hackLevel + 1);
      const cost = hackCosts[hackLevel];
      upgradeCostSpan.textContent = cost.toLocaleString();
      if (hackLevel >= 10) {
        hackUpgradeBtn.innerHTML = "üîì –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –≤–∑–ª–æ–º–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!";
        hackUpgradeBtn.disabled = true;
      } else if (bc < cost) {
        hackUpgradeBtn.innerHTML = `üîì –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BC (${cost.toLocaleString()} –Ω—É–∂–Ω–æ)`;
        hackUpgradeBtn.disabled = true;
      } else {
        hackUpgradeBtn.innerHTML = `
          üîì –£—Ä–æ–≤–µ–Ω—å –≤–∑–ª–æ–º–∞: ${hackLevel} ‚Üí ${hackLevel + 1}<br>
          <small>–ó–∞ —Ç–∞–ø: ${getPerTap(hackLevel)} BC ‚Üí ${getPerTap(hackLevel + 1)} BC</small><br>
          <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost.toLocaleString()} BC</strong>
        `;
        hackUpgradeBtn.disabled = false;
      }
    }

    function updateLimitUpgrade() {
      limitLevelSpan.textContent = limitLevel;
      nextLimitLevelSpan.textContent = limitLevel + 1;
      currentLimitSpan.textContent = getCurrentLimit().toLocaleString();
      const nextLimitValue = getCurrentLimit() + limitIncreases[limitLevel + 1];
      nextLimitSpan.textContent = nextLimitValue.toLocaleString();
      const cost = limitCosts[limitLevel + 1] || 0;
      limitCostSpan.textContent = cost.toLocaleString();
      if (limitLevel >= 5) {
        limitUpgradeBtn.innerHTML = "‚¨ÜÔ∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!";
        limitUpgradeBtn.disabled = true;
      } else if (bc < cost) {
        limitUpgradeBtn.innerHTML = `‚¨ÜÔ∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BC (${cost.toLocaleString()} –Ω—É–∂–Ω–æ)`;
        limitUpgradeBtn.disabled = true;
      } else {
        limitUpgradeBtn.innerHTML = `
          ‚¨ÜÔ∏è –£—Ä–æ–≤–µ–Ω—å –ª–∏–º–∏—Ç–∞: ${limitLevel} ‚Üí ${limitLevel + 1}<br>
          <small>–õ–∏–º–∏—Ç: ${getCurrentLimit().toLocaleString()} ‚Üí ${nextLimitValue.toLocaleString()} BC</small><br>
          <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost.toLocaleString()} BC</strong>
        `;
        limitUpgradeBtn.disabled = false;
      }
    }

    function calculatePendingMiner() {
      if (minerLevel === 0) return 0;
      const ratePerHour = minerRates[minerLevel];
      const elapsedMs = Date.now() - lastMinerClaim;
      const elapsedHours = elapsedMs / 3600000;
      const pending = Math.floor(ratePerHour * elapsedHours);
      const maxPending = ratePerHour * 6;
      return Math.min(pending, maxPending);
    }

    function updateMinerDisplay() {
      const rate = minerRates[minerLevel];
      document.getElementById('miner-rate').textContent = rate.toLocaleString();
      const pending = calculatePendingMiner();
      document.getElementById('pending-miner').textContent = pending.toLocaleString();
      const claimBtn = document.getElementById('claim-miner');
      if (pending > 0) {
        claimBtn.textContent = `–ó–∞–±—Ä–∞—Ç—å ${pending.toLocaleString()} BC`;
        claimBtn.disabled = false;
      } else {
        claimBtn.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ';
        claimBtn.disabled = true;
      }
      const upgradeBtn = document.getElementById('miner-upgrade');
      if (minerLevel >= 5) {
        upgradeBtn.innerHTML = "‚õèÔ∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –º–∞–π–Ω–µ—Ä–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!";
        upgradeBtn.disabled = true;
      } else {
        const next = minerLevel + 1;
        const cost = minerCosts[next];
        const nextRate = minerRates[next];
        if (bc < cost) {
          upgradeBtn.innerHTML = `‚õèÔ∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BC (${cost.toLocaleString()} –Ω—É–∂–Ω–æ)`;
          upgradeBtn.disabled = true;
        } else {
          upgradeBtn.innerHTML = `‚õèÔ∏è –£—Ä–æ–≤–µ–Ω—å –º–∞–π–Ω–µ—Ä–∞: ${minerLevel} ‚Üí ${next}<br><small>–î–æ–±—ã—á–∞: ${rate} ‚Üí ${nextRate} BC/—á–∞—Å</small><br><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost.toLocaleString()} BC</strong>`;
          upgradeBtn.disabled = false;
        }
      }
    }

    function createBubble() {
      if (tapOverlay.style.display !== 'flex') return;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      const size = Math.random() * 20 + 10;
      bubble.style.width = `${size}px`;
      bubble.style.height = `${size}px`;
      bubble.style.left = `${Math.random() * 260 + 10}px`;
      bubble.style.bottom = '20px';
      bubble.style.animationDuration = `${Math.random() * 4 + 4}s`;
      bubble.style.animationDelay = `${Math.random() * 2}s`;
      tapCircle.appendChild(bubble);
      setTimeout(() => bubble.remove(), 8000);
    }

    function startBubbles() {
      if (bubbleInterval) clearInterval(bubbleInterval);
      bubbleInterval = setInterval(createBubble, 800);
    }

    function createCoinParticle(x, y) {
      const particle = document.createElement('div');
      particle.className = 'coin-particle';
      particle.textContent = 'ü™ô';
      particle.style.left = `${x}px`;
      particle.style.top = `${y}px`;
      particle.style.setProperty('--dx', `${(Math.random() - 0.5) * 200}px`);
      particle.style.setProperty('--dy', `${(Math.random() - 0.5) * 200 - 100}px`);
      particle.style.setProperty('--rot', `${Math.random() * 720 - 360}deg`);
      document.body.appendChild(particle);
      setTimeout(() => particle.remove(), 1200);
    }

    document.querySelectorAll('.field').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!btn.classList.contains('unlocked')) return;
        document.body.classList.add('no-scroll');
        tapOverlay.style.display = 'flex';
        tapGain.textContent = getPerTap(hackLevel);
        tapLevel.textContent = hackLevel;
        tg.HapticFeedback.impactOccurred('medium');
        startBubbles();
      });
    });

    function closeTap() {
      document.body.classList.remove('no-scroll');
      tapOverlay.style.display = 'none';
      if (bubbleInterval) clearInterval(bubbleInterval);
      document.querySelectorAll('.bubble').forEach(b => b.remove());
    }

    tapCircle.addEventListener('click', (e) => {
      const now = Date.now();
      if (now - lastTapTime < 100) {
        showMessage("–°–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ... ;)");
        tg.HapticFeedback.impactOccurred('heavy');
        return;
      }
      lastTapTime = now;
      const currentLimit = getCurrentLimit();
      if (todayMined >= currentLimit) {
        showMessage("–õ–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω. –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∑–∞–≤—Ç—Ä–∞ ‚ô°");
        return;
      }
      const gain = getPerTap(hackLevel);
      bc += gain;
      todayMined += gain;
      updateBalance();
      updateDailyMined();
      unlockFields();
      updateLimitUpgrade();
      updateMinerDisplay();
      const rect = tapCircle.getBoundingClientRect();
      const clickX = e.clientX;
      const clickY = e.clientY;
      const numCoins = hackLevel;
      for (let i = 0; i < numCoins; i++) {
        setTimeout(() => createCoinParticle(clickX, clickY), i * 50);
      }
      tg.HapticFeedback.impactOccurred('light');
      showMessage(`+${gain} BC ‚ô°`);
    });

    hackUpgradeBtn.addEventListener('click', () => {
      if (hackUpgradeBtn.disabled) return;
      const cost = hackCosts[hackLevel];
      if (bc < cost) return;
      bc -= cost;
      hackLevel++;
      updateBalance();
      updateHackUpgrade();
      showMessage(`–£—Ä–æ–≤–µ–Ω—å –≤–∑–ª–æ–º–∞ –ø–æ–≤—ã—à–µ–Ω –¥–æ ${hackLevel}! –¢–µ–ø–µ—Ä—å +${getPerTap(hackLevel)} BC –∑–∞ —Ç–∞–ø ‚ô°`);
      saveProgress();
    });

    limitUpgradeBtn.addEventListener('click', () => {
      if (limitUpgradeBtn.disabled) {
        showMessage("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BC –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ ‚ô°");
        return;
      }
      const cost = limitCosts[limitLevel + 1];
      bc -= cost;
      limitLevel++;
      updateBalance();
      updateDailyMined();
      updateLimitUpgrade();
      showMessage(`–õ–∏–º–∏—Ç –ø–æ–≤—ã—à–µ–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–æ–±—ã—Ç—å –¥–æ ${getCurrentLimit()} BC –≤ –¥–µ–Ω—å ‚ô°`);
      saveProgress();
    });

    document.getElementById('miner-upgrade').addEventListener('click', () => {
      if (document.getElementById('miner-upgrade').disabled) {
        showMessage("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BC –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–∞–π–Ω–µ—Ä–∞ ‚ô°");
        return;
      }
      const next = minerLevel + 1;
      const cost = minerCosts[next];
      bc -= cost;
      minerLevel = next;
      if (minerLevel === 1) lastMinerClaim = Date.now();
      updateBalance();
      updateMinerDisplay();
      showMessage(`–ú–∞–π–Ω–µ—Ä —É–ª—É—á—à–µ–Ω –¥–æ —É—Ä–æ–≤–Ω—è ${minerLevel}! –î–æ–±—ã—á–∞ ${minerRates[minerLevel]} BC/—á–∞—Å ‚ô°`);
      saveProgress();
    });

    document.getElementById('claim-miner').addEventListener('click', () => {
      const pending = calculatePendingMiner();
      if (pending > 0) {
        bc += pending;
        lastMinerClaim = Date.now();
        updateBalance();
        updateMinerDisplay();
        saveProgress();
        showMessage(`–ó–∞–±—Ä–∞–Ω–æ ${pending.toLocaleString()} BC –∏–∑ –º–∞–π–Ω–µ—Ä–∞ ‚ô°`);
        tg.HapticFeedback.impactOccurred('light');
      }
    });

    setInterval(() => {
      updateMinerDisplay();
    }, 1000);

    (async () => {
      const serverData = await loadFromServer();
      if (serverData && (serverData.balance > 0 || serverData.today_mined > 0)) {
        loadLocalProgress();
        if (bc < (serverData.balance || 0)) {
          document.getElementById('server-balance').textContent = (serverData.balance || 0).toLocaleString();
          document.getElementById('server-mined').textContent = (serverData.today_mined || 0).toLocaleString();
          document.getElementById('sync-modal').style.display = 'flex';
          document.getElementById('loader').classList.add('hidden');
          window.serverProgress = serverData;
          return;
        }
      }
      loadLocalProgress();
      applyProgress({balance: bc, hack_level: hackLevel, limit_level: limitLevel, today_mined: todayMined, mined_date: minedDate, streak: streak, last_claim: lastClaim, fields_unlocked: fieldsUnlocked, reset_data: resetData, miner_level: minerLevel, last_miner_claim: lastMinerClaim});
      document.getElementById('loader').classList.add('hidden');
    })();

    function loadServerProgress() {
      if (!window.serverProgress) return;
      applyProgress(window.serverProgress);
      saveProgress();
      showMessage("–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞ ‚ô°");
      document.getElementById('sync-modal').style.display = 'none';
    }

    function continueLocal() {
      showMessage("–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ‚ô°");
      document.getElementById('sync-modal').style.display = 'none';
    }
  </script>
</body>
</html>